<ui:composition template="/WEB-INF/template/base.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="jakarta.faces.html"
                xmlns:f="jakarta.faces.core"
                xmlns:ui="jakarta.faces.facelets"
                xmlns:p="http://primefaces.org/ui">

    <f:metadata>
        <f:viewAction action="#{userSession.checkLogin()}" />
        <f:viewAction action="#{citaController.init()}" />
        <f:viewAction action="#{dashboardController.init()}" />
    </f:metadata>

    <ui:define name="title-view">SMILEHUB - Dashboard</ui:define>

    <ui:define name="content">

        <style>
            .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
            .welcome-text h2 { margin: 0; color: #1e293b; font-size: 1.8rem; }
            .welcome-text p { margin: 5px 0 0; color: #64748b; }

            .kpi-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
            .kpi-card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); display: flex; flex-direction: column; border-left: 5px solid #3b82f6; }
            .kpi-value { font-size: 2rem; font-weight: 800; color: #1e293b; margin-bottom: 0.5rem; }
            .kpi-label { color: #64748b; font-size: 0.9rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }

            .border-blue { border-left-color: #3b82f6; }
            .border-green { border-left-color: #10b981; }
            .border-orange { border-left-color: #f59e0b; }
            .border-purple { border-left-color: #8b5cf6; }

            .main-content-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; }
            .card-panel { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
            .card-title { font-size: 1.2rem; font-weight: 700; color: #334155; margin-bottom: 1.5rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 10px; }

            /* --- ESTILO DEL PUNTITO DE CITA --- */
            .tiene-cita a {
                position: relative;
                font-weight: bold !important;
                color: #2563eb !important; /* Azul más fuerte */
            }
            .tiene-cita a::after {
                content: '';
                position: absolute;
                bottom: 2px;
                left: 50%;
                transform: translateX(-50%);
                width: 6px;
                height: 6px;
                background-color: #f59e0b; /* Color naranja/ámbar para el punto */
                border-radius: 50%;
            }

            @media (max-width: 900px) { .main-content-grid { grid-template-columns: 1fr; } }
        </style>

        <script type="text/javascript">
            // Obtenemos la lista de fechas desde el controlador Java
            // Si está vacío, usamos un array vacío para evitar error JS
            var fechasOcupadas = #{citaController.fechasJson != null ? citaController.fechasJson : '[]'};

            function highlightDays(date) {
                // Formateamos la fecha del calendario a 'yyyy-MM-dd' para comparar
                var year = date.getFullYear();
                var month = (date.getMonth() + 1).toString().padStart(2, '0');
                var day = date.getDate().toString().padStart(2, '0');
                var dateStr = year + "-" + month + "-" + day;

                // Si la fecha está en nuestra lista, le ponemos la clase CSS 'tiene-cita'
                if (fechasOcupadas.includes(dateStr)) {
                    return [true, 'tiene-cita'];
                }
                return [true, ''];
            }
        </script>

        <h:form id="dashForm">
            <p:growl id="msgs" showDetail="true" life="3000"/>

            <div class="dashboard-header">
                <div class="welcome-text">
                    <h2>Bienvenida, #{userSession.user.name}</h2>
                    <p>Panel de Gestión SmileHub</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <p:button value="Inicio" icon="pi pi-home" outcome="/dashboardsecretaria" styleClass="ui-button-outlined ui-button-secondary"/>
                    <p:commandButton value="Salir" icon="pi pi-power-off" action="#{userSession.logout}" styleClass="ui-button-danger ui-button-flat" process="@this"/>
                </div>
            </div>

            <div class="kpi-container">
                <div class="kpi-card border-blue">
                    <span class="kpi-value">#{dashboardController.citasHoy}</span>
                    <span class="kpi-label">Citas Hoy</span>
                </div>
                <div class="kpi-card border-orange">
                    <span class="kpi-value">#{dashboardController.pendientes}</span>
                    <span class="kpi-label">Pendientes</span>
                </div>
                <div class="kpi-card border-green">
                    <span class="kpi-value">#{dashboardController.realizadas}</span>
                    <span class="kpi-label">Realizadas</span>
                </div>
                <div class="kpi-card border-purple">
                    <span class="kpi-value">#{dashboardController.nuevosPacientes}</span>
                    <span class="kpi-label">Pacientes Nuevos</span>
                </div>
            </div>

            <div style="margin-bottom: 2rem; display: flex; gap: 15px;">
                <p:commandButton value="Nuevo Doctor" icon="pi pi-briefcase" update=":dialogoDoctor" oncomplete="PF('wdlgDoctor').show()" styleClass="ui-button-help ui-button-raised" style="font-weight: bold;"/>
                <p:commandButton value="Nuevo Paciente" icon="pi pi-user-plus" update=":dialogoPaciente" oncomplete="PF('wdlgPaciente').show()" styleClass="ui-button-success ui-button-raised" style="font-weight: bold;"/>
                <p:commandButton value="Nueva Cita" icon="pi pi-calendar-plus" actionListener="#{citaController.prepararNuevaCita()}" update=":dialogoCita" oncomplete="PF('wdlgCita').show()" styleClass="ui-button-raised" style="font-weight: bold;"/>
            </div>

            <div class="main-content-grid">

                <div class="card-panel">
                    <div class="card-title">Calendario de Citas</div>
                    <p:calendar id="calendario" mode="inline" style="width: 100%;"
                                beforeShowDay="highlightDays" />
                </div>

                <div class="card-panel">
                    <div class="card-title">Próximas Citas</div>

                    <p:outputLabel value="No hay citas próximas" rendered="#{empty dashboardController.proximasCitas}" style="color: #94a3b8; font-style: italic;" />

                    <ui:repeat value="#{dashboardController.proximasCitas}" var="cita">
                        <div style="padding: 10px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex-grow: 1;">
                                <span style="display:block; font-size: 0.85rem; color: #64748b; font-weight: bold;">
                                    <h:outputText value="#{cita.fechaHora}">
                                        <f:convertDateTime pattern="dd/MM - HH:mm" type="localDateTime"/>
                                    </h:outputText>
                                </span>
                                <span style="font-weight: 600; color: #334155;">
                                    #{cita.paciente.nombres} #{cita.paciente.apellidos}
                                </span>
                                <br/>
                                <span style="font-size: 0.9rem; color: #475569;">#{cita.motivo}</span>
                            </div>

                            <h:panelGroup rendered="#{cita.estado eq 'PENDIENTE'}" style="display: flex; gap: 5px;">
                                <p:commandButton icon="pi pi-check" styleClass="ui-button-rounded ui-button-success ui-button-flat"
                                                 title="Marcar como Realizada"
                                                 actionListener="#{citaController.cambiarEstado(cita, 'REALIZADA')}"
                                                 update=":dashForm" />

                                <p:commandButton icon="pi pi-times" styleClass="ui-button-rounded ui-button-danger ui-button-flat"
                                                 title="Cancelar Cita"
                                                 actionListener="#{citaController.cambiarEstado(cita, 'CANCELADA')}"
                                                 update=":dashForm" />
                            </h:panelGroup>

                            <p:tag value="#{cita.estado}"
                                   severity="#{cita.estado eq 'PENDIENTE' ? 'warning' : (cita.estado eq 'REALIZADA' ? 'success' : 'danger')}"
                                   rendered="#{cita.estado ne 'PENDIENTE'}"/>
                        </div>
                    </ui:repeat>
                </div>
            </div>
        </h:form>

        <p:dialog header="Agendar Nueva Cita" widgetVar="wdlgCita" modal="true" width="500" showEffect="fade" hideEffect="fade">
            <h:form id="dialogoCita">
                <div class="ui-fluid">
                    <div class="field" style="margin-bottom: 1rem;">
                        <p:outputLabel for="fecha" value="Fecha y Hora" style="font-weight: bold;"/>
                        <p:datePicker id="fecha" value="#{citaController.nuevaCita.fechaHora}" showTime="true" pattern="dd/MM/yyyy HH:mm" required="true"/>
                    </div>
                    <div class="field" style="margin-bottom: 1rem;">
                        <p:outputLabel for="paciente" value="Paciente" style="font-weight: bold;"/>
                        <div class="ui-inputgroup">
                            <p:selectOneMenu id="paciente" value="#{citaController.nuevaCita.paciente}" converter="entityConverter" filter="true" filterMatchMode="contains" style="width: 100%" required="true">
                                <f:selectItem itemLabel="Buscar Paciente..." itemValue="#{null}" noSelectionOption="true"/>
                                <f:selectItems value="#{citaController.listaPacientes}" var="p" itemLabel="#{p.nombres} #{p.apellidos} - #{p.cedula}" itemValue="#{p}" />
                            </p:selectOneMenu>
                            <p:commandButton icon="pi pi-plus" styleClass="ui-button-success" onclick="PF('wdlgPaciente').show()" type="button"/>
                        </div>
                    </div>
                    <div class="field" style="margin-bottom: 1rem;">
                        <p:outputLabel for="doctor" value="Doctor" style="font-weight: bold;"/>
                        <p:selectOneMenu id="doctor" value="#{citaController.nuevaCita.doctor}" converter="entityConverter" required="true">
                            <f:selectItem itemLabel="Seleccione Doctor..." itemValue="#{null}" />
                            <f:selectItems value="#{citaController.listaDoctores}" var="d" itemLabel="Dr. #{d.nombres} #{d.apellidos}" itemValue="#{d}" />
                        </p:selectOneMenu>
                    </div>
                    <div class="field" style="margin-bottom: 1.5rem;">
                        <p:outputLabel for="motivo" value="Motivo" style="font-weight: bold;"/>
                        <p:inputTextarea id="motivo" value="#{citaController.nuevaCita.motivo}" rows="3" />
                    </div>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <p:commandButton value="Cancelar" onclick="PF('wdlgCita').hide()" styleClass="ui-button-secondary ui-button-flat" process="@this"/>
                    <p:commandButton value="Agendar" icon="pi pi-check" actionListener="#{citaController.agendarCita()}" update=":dashForm:msgs, dialogoCita" oncomplete="if (!args.validationFailed) PF('wdlgCita').hide()" />
                </div>
            </h:form>
        </p:dialog>

        <p:dialog header="Registrar Paciente" widgetVar="wdlgPaciente" modal="true" width="450">
            <h:form id="dialogoPaciente">
                <div class="ui-fluid">
                    <p:panelGrid columns="1" layout="grid" styleClass="ui-panelgrid-blank">
                        <p:inputText value="#{citaController.nuevoPaciente.cedula}" placeholder="Cédula *" required="true"/>
                        <p:inputText value="#{citaController.nuevoPaciente.nombres}" placeholder="Nombres *" required="true"/>
                        <p:inputText value="#{citaController.nuevoPaciente.apellidos}" placeholder="Apellidos *" required="true"/>
                        <p:inputText value="#{citaController.nuevoPaciente.telefono}" placeholder="Teléfono" />
                        <p:inputText value="#{citaController.nuevoPaciente.correo}" placeholder="Correo" />
                    </p:panelGrid>
                    <div style="margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px;">
                        <p:commandButton value="Cancelar" onclick="PF('wdlgPaciente').hide()" styleClass="ui-button-secondary ui-button-flat" process="@this"/>
                        <p:commandButton value="Guardar" icon="pi pi-save" actionListener="#{citaController.guardarPaciente()}" update=":dashForm:msgs, :dialogoCita:paciente" oncomplete="if (!args.validationFailed) PF('wdlgPaciente').hide()" styleClass="ui-button-success"/>
                    </div>
                </div>
            </h:form>
        </p:dialog>

        <p:dialog header="Registrar Doctor" widgetVar="wdlgDoctor" modal="true" width="450">
            <h:form id="dialogoDoctor">
                <div class="ui-fluid">
                    <p:panelGrid columns="1" layout="grid" styleClass="ui-panelgrid-blank">
                        <p:inputText value="#{citaController.nuevoDoctor.cedula}" placeholder="Cédula *" required="true"/>
                        <p:inputText value="#{citaController.nuevoDoctor.nombres}" placeholder="Nombres *" required="true"/>
                        <p:inputText value="#{citaController.nuevoDoctor.apellidos}" placeholder="Apellidos *" required="true"/>
                        <p:inputText value="#{citaController.nuevoDoctor.especialidad}" placeholder="Especialidad *" required="true"/>
                    </p:panelGrid>
                    <div style="margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px;">
                        <p:commandButton value="Cancelar" onclick="PF('wdlgDoctor').hide()" styleClass="ui-button-secondary ui-button-flat" process="@this"/>
                        <p:commandButton value="Guardar" icon="pi pi-save" actionListener="#{citaController.guardarDoctor()}" update=":dashForm:msgs, :dialogoCita:doctor" oncomplete="if (!args.validationFailed) PF('wdlgDoctor').hide()" styleClass="ui-button-info"/>
                    </div>
                </div>
            </h:form>
        </p:dialog>

    </ui:define>
</ui:composition>